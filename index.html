<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>4Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- 出題設定画面 -->
<div id="selector" style="display: block;">
  <h1>出題設定</h1>
  <form id="quiz-form" class="form-card card-animated" onsubmit="return submitSelection()">

    <fieldset style="text-align:left; max-width:400px; margin:auto;">
      <legend>ゲーム種別</legend>
      <label><input type="checkbox" name="quiz" value="LOL" checked> League of Legends</label><br>
      <label><input type="checkbox" name="quiz" value="APEX"> Apex Legends</label><br>
      <label><input type="checkbox" name="quiz" value="OW2"> Overwatch 2</label><br>
      <label><input type="checkbox" name="quiz" value="ST6"> STREET FIGHTER 6</label><br>
    </fieldset>

    <fieldset style="text-align:left; max-width:400px; margin:auto; margin-top:20px;">
      <legend>問題数</legend>
      <label><input type="radio" name="amount" value="all" checked> すべて</label><br>
      <label><input type="radio" name="amount" value="10"> 10問</label><br>
    </fieldset>

    <fieldset style="text-align:left; max-width:400px; margin:auto; margin-top:20px;">
      <legend>設定オプション</legend>
      <label><input type="checkbox" id="instantFeedback" checked> 回答時に正解・不正解を表示</label>
    </fieldset>

    <div class="control">
      <button type="submit">スタート</button>
    </div>
  </form>
</div>

<!-- クイズ進行画面 -->
<div id="quiz-area" style="display: none;">
  <div class="question" id="question"></div>  <!-- 問題文 -->
  <div id="choices" class="choices"></div>     <!-- 選択肢ボタン -->
  <div id="feedback"></div>                    <!-- 正解/不正解メッセージ -->
  <div class="control" id="control"></div>      <!-- 「詳細を見る」「スタートに戻る」 -->
  <div id="details" style="margin-top:20px;"></div> <!-- 回答詳細 -->
  <div id="score">正解数：0問</div>              <!-- 正解数表示 -->
</div>

<script>
  const quizFunctionMap = {
    LOL: 'getLOLQuizData',
    APEX: 'getAPEXQuizData',
    OW2: 'getOW2QuizData',
    ST6: 'getST6QuizData'
  };

  let quizDataList = [];
  let selectedQuizzes = [];
  let loaded = 0;
  let questionLimit = null;
  let quizData = [], currentQuestion = 0, correctAnswers = 0, userAnswers = [];

  function submitSelection() {
    selectedQuizzes = Array.from(document.querySelectorAll('input[name="quiz"]:checked')).map(cb => cb.value);
    questionLimit = document.querySelector('input[name="amount"]:checked')?.value;

    if (selectedQuizzes.length === 0) {
      alert("最低1つは選択してください。");
      return false;
    }

    document.getElementById("selector").style.display = "none";
    document.getElementById("quiz-area").style.display = "block";

    quizDataList = [];
    loaded = 0;

    selectedQuizzes.forEach(quizKey => {
      const scriptName = `${quizKey}.js`;
      const script = document.createElement("script");
      script.src = scriptName;
      script.onload = () => {
        const funcName = quizFunctionMap[quizKey];
        if (typeof window[funcName] === 'function') {
          quizDataList.push(window[funcName]());
        }
        loaded++;
        if (loaded === selectedQuizzes.length) {
          initQuiz();
        }
      };
      document.head.appendChild(script);
    });

    return false;
  }

  function initQuiz() {
    const merged = quizDataList.flat();
    if (merged.length === 0) {
      document.getElementById("question").textContent = "クイズデータが読み込めませんでした。";
      return;
    }
    window.originalQuizData = merged;
    runQuiz();
  }

  function shuffleArray(array) {
    return array.map(a => ({ val: a, rnd: Math.random() }))
                .sort((a, b) => a.rnd - b.rnd)
                .map(a => a.val);
  }

  function runQuiz() {
    let baseData = shuffleArray(window.originalQuizData);
    if (questionLimit !== 'all') baseData = baseData.slice(0, parseInt(questionLimit));
    quizData = baseData.map(q => {
      const shuffled = shuffleArray(q.choices);
      return {
        question: q.question,
        choices: shuffled,
        answer: shuffled.indexOf(q.choices[q.answer]),
        correct: q.choices[q.answer]
      };
    });

    currentQuestion = 0;
    correctAnswers = 0;
    userAnswers = [];
    showQuestion();
  }

  function showQuestion() {
    const q = quizData[currentQuestion];
    document.getElementById("question").textContent = `Q${currentQuestion + 1}. ${q.question}`;
    const choicesDiv = document.getElementById("choices");
    choicesDiv.innerHTML = "";

    q.choices.forEach((choice, i) => {
      const btn = document.createElement("button");
      btn.textContent = choice;
      btn.onclick = () => checkAnswer(i);
      choicesDiv.appendChild(btn);
    });

    document.getElementById("feedback").innerHTML = "";
  }

  function checkAnswer(selectedIndex) {
    const q = quizData[currentQuestion];
    const isCorrect = selectedIndex === q.answer;

    // 正解・不正解表示
    const feedback = document.getElementById('feedback');
    feedback.textContent = isCorrect ? "正解！" : "不正解...";
    feedback.style.color = isCorrect ? 'red' : 'blue';

    if (isCorrect) correctAnswers++;

    // 正解数更新
    document.getElementById("score").textContent = `正解数：${correctAnswers}問`;

    // ボタンを無効化
    const buttons = document.querySelectorAll("#choices button");
    buttons.forEach(btn => btn.disabled = true);

    // 1秒後次の問題へ
    setTimeout(() => {
      currentQuestion++;
      if (currentQuestion < quizData.length) {
        showQuestion();
      } else {
        showEnd();
      }
    }, 1000);
  }

  function showEnd() {
    document.getElementById("question").textContent = "クイズ終了！";
    document.getElementById("choices").innerHTML = "";
    document.getElementById("feedback").textContent = `あなたの正解数：${correctAnswers} / ${quizData.length}`;
    document.getElementById("control").innerHTML = `
      <button onclick="showDetails()">詳細を見る</button>
      <button onclick="location.reload()">スタートに戻る</button>
    `;
  }

  function showDetails() {
    const detailsDiv = document.getElementById("details");
    detailsDiv.innerHTML = '<h3>回答詳細</h3>';
    quizData.forEach((q, index) => {
      const isCorrect = userAnswers[index] === q.answer;
      const userAnswerText = q.choices[userAnswers[index]] || "未回答";
      detailsDiv.innerHTML += `
        <div class="${isCorrect ? 'correct-box' : 'incorrect-box'}">
          <strong>Q${index + 1}: ${q.question}</strong><br>
          あなたの答え: ${userAnswerText}<br>
          正解: ${q.correct}
        </div>`;
    });
  }
</script>

</body>
</html>
